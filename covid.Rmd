---
title: "Using ggplot2 to visualise Covid-19 deaths the UK"
author: "Andi (almost@gmail.com, @[inductivestep](https://twitter.com/InductiveStep))"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: github_document
---


### Load packages

```{r message=FALSE}
library(tidyverse)
library(lubridate)
```

(I thought `lubridate` was part of `tidyverse` - apparently not.)

### Get the data

The latest data is available from Department of Health and Social Care and Public Health England [over here](https://www.gov.uk/guidance/coronavirus-covid-19-information-for-the-public).

```{r message = FALSE}
death <- read_csv("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/896264/COVID-19_UK_deaths_time_series_29_June.csv")
names(death)
```
Those variables names are _very long_ but I'll just keep them as-is and use backquotes.

In RStudio, this views the data:

```{r}
View(death)
```


### Fix the dates

Parse the "%d-%b-%y" format (e.g., "28-Jun-20") as a POSIXct date.

```{r}
death2 <- death %>%
  mutate_at(vars(`Publicly confirmed as deceased as of 5pm this day`),
            function(x) readr::parse_date(x, "%d-%b-%y"))
```

Also add variables for the day of week (Monday, Tuesday, ...) and the date of the Monday on the start of each week. 

```{r}
death2 <- death2 %>%
  mutate(`Day of week` = wday(`Publicly confirmed as deceased as of 5pm this day`,
                              label = T,
                              week_start = 1),
         Week = floor_date(`Publicly confirmed as deceased as of 5pm this day`,
                            unit = "weeks",
                            week_start = 1))

```


```{r}
death2 %>%
  select(`Publicly confirmed as deceased as of 5pm this day`,
         `Day of week`,
         Week) %>%
  head(10)
```



### Plot

First, plot number of deaths reported every day, colouring points by day of week.

```{r}
ggplot(death2, aes(x = `Publicly confirmed as deceased as of 5pm this day`,
                   y = `UK Daily count of deaths in all settings`)) + 
  scale_colour_hue() + # Day of week is ordered; this uses a qual palette
  geom_line(color = "grey") +
  geom_point(aes(color=`Day of week`))
```


We can also add separate lines for each day of the week like this:

```{r}
ggplot(death2, aes(x = `Publicly confirmed as deceased as of 5pm this day`,
                   y = `UK Daily count of deaths in all settings`,
                   color = `Day of week`)) + 
  geom_line() +
  geom_point() +
  scale_colour_hue() 
```

Deaths are reported when paperwork is filed, rather than time of death, which apparently explains the dips on Saturday and Sunday.

### Aggregrate by week

One way to "smooth" the data is sum by week:

```{r message = FALSE}
death_week <- death2 %>%
  group_by(Week) %>%
  summarise(`Weekly Deaths` = sum(`UK Daily count of deaths in all settings`),
            Days = n())
```


```{r}
p <- ggplot(death_week, aes(x = Week, y = `Weekly Deaths`)) +
         geom_point() +
         geom_smooth(method = "gam", se = F) 
p
```


### Change by week

Plot change in the number of deaths compared to the previous week.

```{r}
death_week$Last_Week_Deaths <- lag(death_week$`Weekly Deaths`,1)
death_week$Change           <- with(death_week, `Weekly Deaths` - Last_Week_Deaths)
```



```{r message = FALSE, warning = FALSE}
p <- ggplot(death_week, aes(x = Week, y = Change)) +
         geom_point() +
         geom_hline(yintercept=0) +
         geom_smooth(method = "gam", se = F) +
         ylab("Change in number of deaths since previous week")
p
```



